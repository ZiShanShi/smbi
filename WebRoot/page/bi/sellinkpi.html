<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>sellin kpi</title>
    <link href="../../css/common11.css" rel="stylesheet">
    <link href="../../css/main.css" rel="stylesheet">
    <link href="../../css/control.css" rel="stylesheet">
    <link href="../../css/report.css" rel="stylesheet">
    <link href="../../css/iconfont.css" rel="stylesheet">
    <link href="../../css/grid.css" rel="stylesheet">

    <script src="../../js/jquery1.8.min.js"></script>
    <script src="../../js/jquery-ui-1.10.4.js"></script>
    <script src="../../js/foundation-2.0.js"></script>
    <script src="../../js/control.js"></script>
    <script src="../../data/sellindata.js"></script>
    <script src="../../js/designer.js"></script>
    <script src="../../js/echarts.min.js"></script>
    <script src="../../js/grid.js"></script>
    <script src="../../js/staticpaneldata.js"></script>

    <script type="text/javascript">
        var mainTool, chartTool, chartToolItems, reportPanel, gridPanel;
        var chart, grid;

        var option = {
                "tooltip": {
                    "trigger": "axis",
                    "axisPointer": {
                        "type": "shadow",
                        textStyle: {
                            color: "#fff"
                        }

                    },
                },
                "grid": {
                    "borderWidth": 0,
                    "top": 110,
                    "bottom": 95,
                    textStyle: {
                        color: "#fff"
                    }
                },
                "legend": {
                    textStyle: {
                        color: '#90979c',
                    },
                    "data": ['销售额', '指标', '达成率']
                },
                "calculable": true,
                "xAxis": [{
                    "type": "category",
                    "axisLine": {
                        lineStyle: {
                            color: '#90979c'
                        }
                    },
                    "data": ['1季度','2季度','3季度','4季度'],
                }],
                "yAxis": [{
                    "type": "value",
                    name:"金额(K)",
                    "splitLine": {
                        "show": false
                    },
                    "axisLine": {
                        lineStyle: {
                            color: '#87cefa'
                        }
                    },
                    "axisTick": {
                        "show": false
                    },
                    "axisLabel": {
                        "interval": 0,

                    },
                    "splitArea": {
                        "show": false
                    },

                },
                    {
                        "type": "value",
                        name:"达成率",
                        "splitLine": {
                            "show": false
                        },
                        "axisLine": {
                            lineStyle: {
                                color: '#87cefa'
                            }
                        },
                        "axisTick": {
                            "show": false
                        },
                        "axisLabel": {
                            "interval": 0,

                        },
                        "splitArea": {
                            "show": false
                        },

                    }],
                "series": [{
                    "name": "销售额",
                    "type": "bar",
                    "barGap": "10%",
                    "itemStyle": {
                        "normal": {
                            "color": "rgba(255,144,128,1)",
                            "label": {
                                "show": true,
                                "position": "top",
                                formatter: function(p) {
                                    return p.value > 0 ? (p.value) : '';
                                }
                            }
                        }
                    },
                    "data": [
                        163473.99,
                        186865.85,
                        217684.23,
                        236707.57

                    ],
                },

                    {
                        "name": "指标",
                        "type": "bar",
                        "itemStyle": {
                            "normal": {
                                "color": "rgba(0,191,183,1)",
                                "barBorderRadius": 0,
                                "label": {
                                    "show": true,
                                    "position": "top",
                                    formatter: function(p) {
                                        return p.value > 0 ? (p.value) : '';
                                    }
                                }
                            }
                        },
                        "data": [
                            162244.80,
                            162244.80,
                            175765.20,
                            175765.20
                        ]
                    }, {
                        "name": "达成率",
                        yAxisIndex:1,
                        "type": "line",
                        symbolSize:10,
                        symbol:'circle',
                        "itemStyle": {
                            "normal": {
                                "color": "rgba(252,20,148,1)",
                                "barBorderRadius": 0,
                                "label": {
                                    "show": true,
                                    "position": "top",
                                    formatter: function(p) {
                                        return p.value > 0 ? (p.value)+"%" : '0%';
                                    }
                                }
                            }
                        },
                        "data": [
                            100,
                            115,
                            123,
                            134
                        ]
                    },
                ]
            };

        var tabledata = [
            {"no":1, "DistributorName":"", "distributorcode":"", "year":2019,"month": 3,"Region": "", "rsm":"", "Supervisorcode":"", "RSM":"", "Supervisor":"", "YTDAmount ":"1,936,554.00","Q1Amount": "1,936,554.00", "Q2Amount":"0.00", "Q3Amount":"0.00",  "Q4Amount":"0.00", "MAmount":"8,547.00", "YRP":"", "Q1RP ":"", "Q2RP":"", "Q3RP ":"", "Q4RP":"", "MRP":"", "Brand":"Straumann"},

            {"no":2, "DistributorName":"", "distributorcode":"", "year":2019,"month": 3,"Region": "", "rsm":"", "Supervisorcode":"", "RSM":"",  "Supervisor ":"", "YTDAmount ":"2,673,949.00","Q1Amount": "2,673,949.00", "Q2Amount":"0.00", "Q3Amount":"0.00", "Q4Amount":"0.00", "MAmount":"114,400.00", "YRP":"", "Q1RP ":"", "Q2RP":"", "Q3RP ":"", "Q4RP":"", "MRP":"", "Brand":"Straumann"},

            {"no":3, "DistributorName":"合肥和奥医疗器械有限公司","distributorcode": "56500049","year": 2019,"month": 3,"Region": "East","rsm": "U106058_01","Supervisorcode": "U106810","RSM": "Leo lv_暂管",  "Supervisor ":"Niki Cao","YTDAmount ": "1,153,711.00", "Q1Amount":"1,153,711.00", "Q2Amount":"0.00", "Q3Amount":"0.00", "Q4Amount":"0.00", "MAmount ":"446,297.00", "YRP":"", "Q1RP ":"", "Q2RP":"", "Q3RP ":"", "Q4RP":"", "MRP":"", "Brand":"Straumann"},

            {"no":4, "DistributorName":"上海思创医疗器械有限公司","distributorcode": "56501400","year": 2019,"month": 3,"Region": "East","rsm": "U106058","Supervisorcode": "U106110","RSM": "Leo Lv",  "Supervisor ":"Hale Yu","YTDAmount ": "23,720,675.00", "Q1Amount":"23,720,675.00", "Q2Amount":"0.00", "Q3Amount":"0.00", "Q4Amount":"0.00", "MAmount ":"2,691,690.00", "YRP":"", "Q1RP ":"", "Q2RP":"", "Q3RP ":"", "Q4RP":"", "MRP":"", "Brand":"Straumann"},

            {"no":5, "DistributorName":"杭州昆德医疗器械有限公司","distributorcode": "56501920","year": 2019,"month": 3,"Region": "East","rsm": "U106058","Supervisorcode": "U106352","RSM": "Leo Lv",  "Supervisor ":"Simon Wu", "YTDAmount ":"14,747,125.00","Q1Amount": "14,747,125.00", "Q2Amount":"0.00", "Q3Amount":"0.00", "Q4Amount":"0.00", "MAmount ":"4,124,316.00", "YRP":"", "Q1RP ":"", "Q2RP":"", "Q3RP ":"", "Q4RP":"", "MRP":"", "Brand":"Straumann"},

            {"no":6, "DistributorName":"江苏美安医药股份有限公司","distributorcode": "56501923","year": 2019,"month": 3,"Region": "East","rsm": "U106058_01","Supervisorcode": "U106810","RSM": "Leo lv_暂管", "Supervisor ": "Niki Cao", "YTDAmount ":"6,360,378.00", "Q1Amount":"6,360,378.00", "Q2Amount":"0.00", "Q3Amount":"0.00", "Q4Amount":"0.00","MAmount ": "644,091.00", "YRP":"", "Q1RP ":"", "Q2RP":"", "Q3RP ":"", "Q4RP":"", "MRP":"", "Brand":"Straumann"},

            {"no":7, "DistributorName":"安徽明悦医疗科技有限公司","distributorcode": "56502021","year": 2019,"month": 3,"Region": "East","rsm": "U106058_01","Supervisorcode": "U106810","RSM": "Leo lv_暂管", "Supervisor ": "Niki Cao","YTDAmount ": "2,181,010.00", "Q1Amount":"2,181,010.00", "Q2Amount":"0.00", "Q3Amount":"0.00", "Q4Amount":"0.00", "MAmount ":"313,277.00", "YRP":"", "Q1RP ":"", "Q2RP":"", "Q3RP ":"", "Q4RP":"", "MRP":"", "Brand":"Straumann"},

            {"no":8, "DistributorName":"宁波蓝野医疗器械有限公司","distributorcode": "56504187","year": 2019,"month": 3,"Region": "East","rsm": "U106058","Supervisorcode": "U106352","RSM": "Leo Lv", "Supervisor ": "Simon Wu", "YTDAmount ":"112,035.00", "Q1Amount":"112,035.00", "Q2Amount":"0.00", "Q3Amount":"0.00", "Q4Amount":"0.00", "MAmount":"0.00", "YRP":"", "Q1RP ":"", "Q2RP":"", "Q3RP ":"", "Q4RP":"", "MRP":"", "Brand":"Straumann"},

            {"no":9, "DistributorName":"山东瑞康德一医疗器械有限公司","distributorcode": "56500041","year": 2019,"month": 3,"Region": "North","rsm": "U111626","Supervisorcode": "U105857","RSM": "Mike Luo", "Supervisor": "Even Liu", "YTDAmount ":"90,620.00", "Q1Amount":"90,620.00", "Q2Amount":"0.00", "Q3Amount":"0.00", "Q4Amount":"0.00", "MAmount":"0.00", "YRP":"", "Q1RP ":"", "Q2RP":"", "Q3RP ":"", "Q4RP":"", "MRP":"", "Brand":"Straumann"},

            {"no":10,"DistributorName": "北京德诺联康科技发展有限公司","distributorcode": "56500047","year": 2019,"month": 3,"Region": "North","rsm": "U111626","Supervisorcode": "U105988","RSM": "Mike Luo",  "Supervisor":"Kevin Yang","YTDAmount ": "942,893.00", "Q1Amount":"942,893.00", "Q2Amount":"0.00", "Q3Amount":"0.00", "Q4Amount":"0.00", "MAmount":"0.00", "YRP":"", "Q1RP ":"", "Q2RP":"", "Q3RP ":"", "Q4RP":"", "MRP":"", "Brand":'Straumann'}


        ];
        function getReportChartTypes(report) {
            var charts = report.theme.chart;
            var result = [];

            for (var i = 0; i < charts.length; i++) {
                var code = charts[i];
                var btnOption = ButtonList[code];

                result.push({
                    "code": code,
                    "img": btnOption.img
                });
            }
            return result;
        }

        function resetPanelData(widget) {
            OlapTab.init([
                {code: "olap-filters", header: "olap-filters-header", body: "olap-filters"},
                {code: "olap-fields", header: "olap-fields-header", body: "olap-fields"}
            ]);

            chartToolItems = getReportChartTypes(report);

            mainTool = new Toolbar({
                element: "#mainTool",
                items: [
                    {type: "spliter"},
                    {
                        text: "导出数据", icon: "icon-yunduanxiazai", onClick: function () {
                            alert("导出数据");
                        }
                    },
                    {
                        text: "导出图表", icon: "icon-weizhigeshi", onClick: function () {
                            alert("导出图表");
                        }
                    },
                    {
                        text: "数据列表", icon: "icon-liebiao2", onClick: function () {
                            alert("数据列表");
                        }
                    },
                    {type: "spliter"},
                    {
                        text: "报表设计", icon: "icon-ceshishenqing", onClick: function () {
                            alert("报表设计");
                        }
                    },
                    {type: "spliter"},
                    {
                        text: "报表说明", icon: "icon-huixingzhen", onClick: function () {
                            alert("报表说明");
                        }
                    },
                    {
                        text: "操作手册", icon: "icon-icon_bangzhuwendang", onClick: function () {
                            alert("操作手册");
                        }
                    }
                ]
            });

            chartTool = new Toolbar({
                element: "#chartTool",
                showText: false,
                autoSize: true,
                items: chartToolItems,
                imgPath: "../../img/charttype/",
                btnTemplate: "<span><img id='img' class='tool-img'></span>",
                onClick: function (code) {
                    var series = option.series;
                    for (var i = 0; i < series.length; i++) {
                        series[i].type = code;
                    }

                    chart.setOption(option);
                }
            });

            AxisArea.init({
                element: "#area-axis",
                axises: widget.axisList,
                onFieldClick: function (name, option) {
                    alert(name);
                }
            });

            FieldArea.init({
                element: "#olap-fields",
                report: report,
                groupIcon: "icon-liebiao",
                onChangeFilterSetting: function (fieldOption, checked) {
                    console.info(fieldOption);
                    if (checked) {
                        FilterArea.addFilter(fieldOption.group.code, fieldOption);
                    }
                    else {
                        FilterArea.deleteFilter(fieldOption);
                    }
                    resetGrid();
                }
            });

            FilterArea.init({
                element: "#olap-filters",
                items: FieldArea.checkItems,
                groupIcon: "icon-liebiao",
                onFilterChange : function () {
                    resetGrid();
                }
            });

            Spliter.init({
                element: "#spliterbar",
                left: "#area-olap",
                right: "#area-content"
            });

            var gridOption = widget.gridOption;
            if (gridOption != null) {
                grid = new $.fm.Grid({
                    element: "grid",
                    showPage:true,
                    limit: gridOption.page.pageSize,
                    hasSubTitle: gridOption.hasTitle,
                    columns:[
                        {field: "no", caption: "no", width: 120},
                        {field: "DistributorName", caption: "经销商名称", width: 120},
                        {field: "distributorcode", caption: "经销商编码", width: 120},
                        {field: "Year", caption: "年", width: 120},
                        {field: "Month", caption: "月", width: 120},
                        {field: "Region", caption: "大区", width: 120},
                        {field: "rsm", caption: "RSM", width: 120},
                        {field: "Supervisor", caption: "主管", width: 120},
                        {field: "YTDAmount", caption: "YTD销售额", width: 120},
                        {field: "Q1Amount", caption: "Q1销售额", width: 120},
                        {field: "Q2Amount", caption: "Q2销售额", width: 120},
                        {field: "Q3Amount", caption: "Q3销售额", width: 120},
                        {field: "Q4Amount", caption: "Q4销售额", width: 120},
                        {field: "MAmount", caption: "月销售额", width: 120},
                        {field: "YRP", caption: "YTD达成率%", width: 120},
                        {field: "Q1RP", caption: "Q1达成率%", width: 120},
                        {field: "Q2RP", caption: "Q2达成率%", width: 120},
                        {field: "Q3RP", caption: "Q3达成率%", width: 120},
                        {field: "Q4RP", caption: "Q4达成率%", width: 120},
                        {field: "MRP", caption: "月达成率%", width: 120},
                        {field: "Brand", caption: "产品线", width: 120}
                    ]
                });

                grid.loadData(tabledata, 1);
            }


            chart.setOption(option);
        }

        function resetGrid() {
            var aggcode = "";
            var reShowColumns = [];
            Object.keys(FieldArea.checkItems).forEach( function(key) {
                var item = FieldArea.checkItems[key];
                var option = item.option;

                var field =  {field: option.showField.toLowerCase(), caption: option.caption, width: 120};
                reShowColumns.push(field);
                var group = item.group;

                if(group && "peroid" != group.code && "area" != group.code) {
                    var groupcode = group.code;
                    aggcode += groupcode + "." + key + ";";
                }else {
                    aggcode += key +";";
                }

            });

            var filter = FilterArea.getFilterUrl(true);
            var paramsObj = {
                code: report.topic,
                fields:aggcode,
                userType:"superAdmin",
                isTable:true
            }
            Loading.show("重组报表中。。。");
            $("#grid").empty();

            grid = new $.fm.Grid({
                element: "grid",
                limit: 20,
                showPage:true,
                hasSubTitle: true,
                columns:reShowColumns
            });

            var params = $.fm.objectToURI(paramsObj) + "&" + filter;
            var gridurl = "root/bi/data?"+ params;
            grid.url = gridurl;
            Server.getData(gridurl, function(row, page) {
                Loading.hide();
                grid.loadData(row, page);
            });
        }

        $(document).ready(function () {
            reportPanel = $("#reportPanel");
            gridPanel = $("#gridPanel");

            chart = echarts.init(document.getElementById('reportPanel'));

            /*Server.getData("root/report/getWidget?id=001", function (widget) {
                resetPanelData(widget);
            })*/

            resetPanelData(staticdatas.widget);
            //$( ".selector" ).draggable( "option", "scope", "tasks" );

        });

    </script>
</head>

<body>
<div id="mainTool" class="area-tool" style="position: fixed;"></div>

<div id="area-olap" class="area-olap">
    <div class="area-olap-header">
        <div id="olap-filters-header" class="tab-header" onclick="OlapTab.changeActive('olap-filters')">
            <span class="iconfont icon-chazhaobiaodanliebiao"></span>
            过滤条件
        </div>
        <div id="olap-fields-header" class="tab-header" onclick="OlapTab.changeActive('olap-fields')">
            <span class="iconfont icon-chanpin2"></span>
            高级设置
        </div>
    </div>
    <div class="area-olap-body">
        <div class="tab-body-outer">
            <div id="olap-filters" class="tab-body"></div>
        </div>
        <div id="olap-fields" class="tab-body" style="display: none;">
            <div id="olap-fields-dimension" class="area-fields">
            </div>
            <div id="olap-fields-value" class="area-fields">
            </div>
        </div>
    </div>
    <div class="area-olap-tabbody"></div>
</div>

<div id="spliterbar" class="spliterbar"></div>

<div id="area-content" class="area-content">
    <div id="area-axis" class="area-axis">
        <div class="axis-lines">
            <div class="axis-line">
                <div id="y-segment1" class="axis-line-segment" style="width: 50%">
                    <div class="axis-header">
                        Y轴-1
                    </div>
                    <div id="axisY-1" class="axis-body"></div>
                </div>
                <div id="y-segment2" class="axis-line-segment" style="width: 50%">
                    <div class="axis-header">
                        Y轴-2
                    </div>
                    <div id="axisY-2" class="axis-body"></div>
                </div>
            </div>

            <div class="axis-line">
                <div id="x-segment1" class="axis-line-segment" style="width: 50%">
                    <div class="axis-header">
                        X轴-1
                    </div>
                    <div id="axisX-1" class="axis-body"></div>
                </div>
                <div id="x-segment2" class="axis-line-segment" style="width: 50%">
                    <div class="axis-header">
                        X轴-2
                    </div>
                    <div id="axisX-2" class="axis-body"></div>
                </div>
            </div>

            <div class="axis-change">
                <span class="iconfont icon-shuaxin" style="font-size: 14px"></span>
            </div>
        </div>
        <div class="axis-tools">
            <div class="axis-tool-line">
                <div id="axisY-add" class="axis-btn iconfont">
                    +
                </div>
                <div id="axisY-delete" class="axis-btn iconfont">
                    -
                </div>
            </div>
            <div class="axis-tool-line">
                <div id="axisX-add" class="axis-btn">
                    +
                </div>
                <div id="axisX-delete" class="axis-btn">
                    -
                </div>
            </div>
        </div>
    </div>

    <div class="area-report">
        <div class="reportBand">
            <div id="reportPanel" class="reportPanel">

            </div>
            <div id="chartTool" class="chartTool" align="center"></div>
        </div>
        <div class="gridPanel">
            <div id="grid"></div>
        </div>
    </div>
</div>
</body>
</html>